# MODELS19
ℹ _NOTE: anonymized copy of the Topocity repository. Online open-source development is publicly available on github.com_

This repository bundles the data used for the paper, named _Model-Driven Design of City Spaces via
Bidirectional Transformations_, together with the framework we developed.


## Installation
Currently it is recommended to execute `topocity` via [Stack platform][45cc488c], since it is cross-platform, virtualizable, and takes care of all dependencies automatically.

ℹ _Note: [Git][ae045f07] is required by Stack to pull needed pacakges. In addition, drawing commands require [GraphViz][927a319c] installed system-wide._



After cloning/downloading this repository go to its directory and
launch it at the library entry point, by navigating to the `src` directory via command line and then execute:


```
stack ghci Lib.hs
```

## Usage Guidelines

After launching our library, Stack will fetch all dependencies and start the REPL execution when ready.

To experiment with `topocity`, you can execute the following commands in the REPL.



### Loading the CityGML _Source_

```haskell
source = load "1/original.gml" "1/ade.gml"
```

### Showing the result of _Get_

```haskell
view = get source -- performs the forward BX: CityGML -> Bigraph
display view'' -- prints in stdout the internal representation of the graph
```

### Changing the _View_

Wrappers to simulate changes in the view

```haskell
view'  = addBuilding "demo1" view
view'' = removeBuilding "bc8a0f2b5-031b-11e6-b420-2bdcc4ab5d7f" view'
display view'' -- prints in stdout the internal representation of the graph
```

### Reflecting the changes back to source with _Put_

```haskell
source' = put source view''  -- performs the putback BX: CityGML <- Bigraph
```

### Storing back the new _Source_

```haskell
store source' "1_out.gml" "1_aout.gml" -- Stores the new CityGML and ADE files
```

### Quickly check the changes
To check the changes when no gml viewer is available, one could use the diff tool, for example:
```
diff -u ../in/0/original.gml ../out/out.gml
```

## Data Description
Each directory contains the data models for one of the case studies from the paper.

⚠*__WARNING__: Current default XML parser is highly memory-eager: avoid operating on the data from the folder `/2/` unless AT LEAST 16GB are available for the machine.*

Files are organized this way:

- _original.gml_ contains the original source model used - when exceeded 100MB it is substituted with a RAR archive.
- _ade.gml_ contains the Application Domain Extension information.
- _view&#95;raw.txt_ contains the graph generated by the __get__ transformation.
- _view.big_ contains the graph generated in bigraphER syntax (Experimental).
- _out.gml_ contains the new source model generated by the __put__ transformation.

### Scenario 1: Facilitating System Design - Tower Crane Positioning
Original model comes from: [Remscheid LOD1 CityGML Model][74557c32], file *LoD1_369_5668_1_NW.gml*.



###  Scenario 2: Facilitating System Operation - Emergency Response.
Original model comes from: [New York - TUM - Flat Iron Street][fa27df69].   


# Customization
Note that input files are taken from the `topocity/in` directory while output files are generated into the `topocity/out` directory.

To change this, change the paths in `topocity/src/Settings.hs` variables.

The following commands use files provided with this repository, however other input can be used, despite currently there is a very limited support of CityGML features related to the current state of development of the parsing library.

## Development

### Testing & Code Analysis
⚠ _Warning: Unless otherwise specified, all commands are meant to be executed at the root of the project and require the [Stack platform][45cc488c]._

---
To run the code coverage of the testing platform run in your OS's CLI:

```sh
stack test --ghc-options "-fforce-recomp" --coverage
```

and of course to just run the tests you can skip the `--coverage` flag.

### Generate package dependency graph
In order to generate the dependency graph (in this case the trivial dependency on the `base` package has been excluded):

```sh
stack dot --no-include-base --external | dot -Tpng -o out/wreq.png
```

### Generate documentation

To generate the updated documentation, you can write in the same way:

```sh
stack haddock
```

While to generate the report of the Lines of Code (Windows-only), open a terminal at the `tools` directory and execute:
```sh
cloc.exe ../src ../test --report-file=reports/cloc_%DATE%.txt
```

[74557c32]: https://www.opengeodata.nrw.de/produkte/geobasis/3d-gm/3d-gm_lod1/3d-gm_lod1_05120000_Remscheid_EPSG25832_CityGML.zip "Remscheid LOD1 CityGML Model"
[fa27df69]: http://www.3dcitydb.net/3dcitydb/fileadmin/public/datasets/NYC/NYC_street_space_extract/NYC_Flatiron_Streetpace_CityGML_LoD2.zip "New York - TUM"
[927a319c]: https://www.graphviz.org/ "GraphViz"
[45cc488c]: https://haskellstack.org "Haskell Stack Website"
[5d8ff35d]: https://bitbucket.org/prl_tokyo/bigul/ "BiGUL: The Bidirectional Generic Update Language"
[ae045f07]: https://git-scm.com/ "Git"
